@startuml RealTimeProcessingSequence
title Real-Time Processing – Full Sequence

actor Kafka       as K
participant "Stage\nConsumers"   as C
participant RetryJob             as R
database   MySQL                as DB
database   "event_pending"      as P
queue      "Enrich\nQueue"      as Q
participant "Enrich\nConsumer"  as EC
database   "External DB"        as EXT
database   "event_agg"          as AGG
queue      DLQ                  as DLQ

== Stage Processing ==
K -> C : poll(record)
C -> DB : INSERT/UPSERT\n(event_status)
alt 前置缺失
  C -> P : INSERT pending
else Stage4 完成
  C -> Q : produce(stage4)
end

== Enrichment ==
Q -> EC : dequeue
EC -> EXT : batchSelect(eventIds)
EXT --> EC : result set
EC -> DB : batchUpdate extra fields
DB -> AGG : INSERT/UPDATE aggregate

== Retry & DLQ ==
R -> P : SELECT due
alt 依赖满足
  R -> C : reprocess(event)
else 超过最大重试
  R -> DLQ : produce(record)
end
@enduml
